---
title: "Workbook to investigate Question 1"
author: "Paul Gittings"
date: "09/09/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages and libraries}

# function to load library, will first attempt to load package if not present
setupPackage <- function( packageName, loud=FALSE ) {
  if (!require(packageName, character.only=TRUE)) {
    install.packages(packageName, verbose = loud, dependencies = TRUE)
  } 
  library(packageName, character.only=TRUE, verbose = loud)
}

setupPackage("tidyverse")
setupPackage("fastDummies")
setupPackage("PerformanceAnalytics")
setupPackage("corrr")

```

# Intro

The question to be investigated is: Does a relationship exist between the nature of the crash and the crash severity in motorcycle accidents?

Load the main crash data set and assign it to crashDF. EDA should reference crashDF

```{r load dataset}
  crashDF <- read_rds("../datasets/main.Rds")
```

# EDA

```{r get column names}
col_names <- names(crashDF)
print(col_names)
```
```{r get attribute values}
unique(crashDF$Crash_Severity)
#TODO:: turn Crash_Severity into an ordinal - property damage only, Minor Injury, Medical treatment, Hospitalisation, Fatal

unique(crashDF$Crash_Nature)

#NOTE: Crash_Sevrity ~ Crash_Nature is predicting an ordinal factor based on a nominal one
```
```{r historgram crash severity by carsh nature}

ggplot(crashDF, aes(x=Crash_Severity)) +
  geom_bar(stat="count") +
  facet_wrap(~Crash_Nature) +
  theme(axis.text.x = element_text(angle = 90))

```

```{r total accidents by crash nature}

ggplot(crashDF) +
    geom_bar(aes(x = forcats::fct_infreq(Crash_Nature), fill = Crash_Severity)) +
    theme(axis.text.x = element_text(angle = 90)) +
    xlab("Crash Nature")
```
Looking at the obe plot, would it make sense to roll oup some of the Crash_Nature levels, say from "Hit Parked Vehicle" and all those to it's left?

```{r total accidents by crash severity}

ggplot(crashDF) +
    geom_bar(aes(x = forcats::fct_infreq(Crash_Severity), fill = Crash_Nature)) +
    theme(axis.text.x = element_text(angle = 90)) +
    xlab("Crash Severity")
```

# Engineer Data

Steps taken:

* Turn Crash_Severity into an ordinal factor.
* create dummy attributes for Crash_Nature
* all columnm names renamed to replace spaces with "_".


NOTE: from this point on analysis should use the q1CrashDF  dataframe

```{r engineer variables}
# will check to see if we previously saved away the engineered data set and load it 
# rather than re-engineering the main crash data again.
# NOTE: this means that if additional engineering code is added the saved copy of q1CrashDF.Rds
# should be deleted OR the forceDfRebuild variable should be set to TRUE.
forceDfRebuild <- TRUE
q1DfFileName <-"q1CrashDF.Rds"

if( (!forceDfRebuild) & file.exists(q1DfFileName)) {
  q1CrashDF <- read_rds(q1DfFileName)
} else {
  # creat extra dummy columns for the Crash_Nature - should we drop the first one? 
  #     remove_first_dummy = TRUE
  q1CrashDF <- fastDummies::dummy_cols(crashDF, select_columns= "Crash_Nature")
  names(q1CrashDF)<-str_replace_all(names(q1CrashDF), c(" " = "_" , "," = "", "-"="_" ))
  names(q1CrashDF)<-str_replace_all(names(q1CrashDF), c("___" = "_"  ))
  
  # may not need this as we have Count_Fatal, Count_Hospitalisation etc 
  q1CrashDF$Crash_Severity <- factor(q1CrashDF$Crash_Severity, c("Property damage only",
        "Minor injury",  "Medical treatment", "Hospitalisation", "Fatal"), ordered=TRUE)
  
  #q1CrashDF %<>% mutate(non_fatal_acciedent = Count_Casualty_Fatality==0)
  print(names(q1CrashDF))
   
  write_rds(q1CrashDF, q1DfFileName)
  
}
  

```

# Additional EDA

```{r correlation matrix 1 - all}
my_data <- select(q1CrashDF,  Count_Casualty_Fatality, Count_Casualty_Hospitalised,
                  Count_Casualty_MedicallyTreated, Count_Casualty_MinorInjury,
                  Crash_Nature_Angle, Crash_Nature_Collision_miscellaneous,
                  Crash_Nature_Fall_from_vehicle, Crash_Nature_Head_on,
                  Crash_Nature_Hit_animal, Crash_Nature_Hit_object,
                  Crash_Nature_Hit_parked_vehicle, Crash_Nature_Hit_pedestrian,
                  Crash_Nature_Non_collision_miscellaneous, Crash_Nature_Overturned,
                  Crash_Nature_Rear_end, Crash_Nature_Sideswipe,
                  Crash_Nature_Struck_by_external_load
                  )
chart.Correlation(my_data, histogram=TRUE, pch=19)
```


```{r correlattion matrix 2: fatalities}
my_data <- select(q1CrashDF,  Count_Casualty_Fatality, 
                  Crash_Nature_Angle, Crash_Nature_Collision_miscellaneous,
                  Crash_Nature_Fall_from_vehicle, Crash_Nature_Head_on,
                  Crash_Nature_Hit_animal, Crash_Nature_Hit_object,
                  Crash_Nature_Hit_parked_vehicle, Crash_Nature_Hit_pedestrian,
                  Crash_Nature_Non_collision_miscellaneous, Crash_Nature_Overturned,
                  Crash_Nature_Rear_end, Crash_Nature_Sideswipe,
                  Crash_Nature_Struck_by_external_load
                  )
chart.Correlation(my_data, histogram=TRUE, pch=19)
```
Above correlation matrixes are too small, but the results don't look that good. Let's try a text based approach to get the correltions.

```{r alterative to correlation graphs}
corrData <- select(q1CrashDF,  Count_Casualty_Fatality, Count_Casualty_Hospitalised,
                  Count_Casualty_MedicallyTreated, Count_Casualty_MinorInjury,
                  Crash_Nature_Angle, Crash_Nature_Collision_miscellaneous,
                  Crash_Nature_Fall_from_vehicle, Crash_Nature_Head_on,
                  Crash_Nature_Hit_animal, Crash_Nature_Hit_object,
                  Crash_Nature_Hit_parked_vehicle, Crash_Nature_Hit_pedestrian,
                  Crash_Nature_Non_collision_miscellaneous, Crash_Nature_Overturned,
                  Crash_Nature_Rear_end, Crash_Nature_Sideswipe,
                  Crash_Nature_Struck_by_external_load
                  )
 result <- corrData %>% correlate()
 
  
 result %>% focus(names(result)[2])  # Can't seem to be able to use Count_Casulaty_Fatality directly?
 
result %>% focus(names(result)[3])
 
result %>% focus(names(result)[4])

result %>% focus(names(result)[5])
  

```

Correlation analysis doesn't reveal any correlation of any strength between severity of accident and the nature of the accident. The Highest positive correlation is 0.12 between Head On accidents and Fatalities, however this i not a significant correlation. All remaining correlations are above -0.01 and below 0.01  which are no correlation at all.

Go back to the engineering level and introduce a new variable non_fatal.